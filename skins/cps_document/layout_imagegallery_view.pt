<metal:block use-macro="here/layout_lib_div_view/macros/div_view" />
<tal:block tal:define="utool nocall:here/portal_url;
                       proxy nocall:options/proxy;
                       items proxy/getFolderContents;
                       gallery python:here.getContent();
                       nb_cols python:getattr(gallery,'nb_cols','3');
                       nb_items python:int(getattr(gallery,'nb_items',9));
                       page_batch_start python:int(path('request/start | nothing') or 0);
                       page_batch python:modules['ZTUtils'].Batch(items,
                                                                  size=nb_items,
                                                                  start=page_batch_start);
                       previous_page python:page_batch.previous;
                       next_page python:page_batch.next;
                       nb_items_in_current_batch python:len(page_batch);
                       mod python:nb_items_in_current_batch % nb_cols;
                       div python:nb_items_in_current_batch / nb_cols;
                       th_width python:getattr(gallery,'preview_width','64');
                       th_height python:getattr(gallery,'preview_height','64');
                       nb_rows_in_current_batch python:test(mod == 0,div,div + 1);
                       popup_mode python:getattr(gallery, 'popup_mode', 0);
                       popup_width python:getattr(gallery, 'popup_width', 300);
                       popup_height python:getattr(gallery, 'popup_height', 300);
                       ">
<div class="ddefault">
  <table style="text-align:center;width:100%"
    summary="gallery layout">
    <tr tal:repeat="row python:range(nb_rows_in_current_batch)">
    <tal:block tal:define="batch python:modules['ZTUtils'].Batch(page_batch,
                                                                 size=nb_cols,
                                                                 start=row*nb_cols);">
      <td tal:repeat="item batch">
        <a href="."
          tal:define="item_url python:item.absolute_url()"
          tal:attributes="
            href python:test(popup_mode, '.', item_url);
            onClick python:test(popup_mode, 'window.open(\'' +
                      item_url +
                      '/popup_image' + '?pos=%s' % (repeat['row'].index * nb_cols + repeat['item'].index + page_batch_start) +
                      '\', \'view_image\', ' +
                      '\'innerwidth=%s' % popup_width +
                      ',innerheight=%s' % popup_height +
                      ',location=no' +
                      ',menubar=no' +
                      ',personalbar=no' +
                      ',toolbar=no' +
                      ',status=no' +
                      ',scrollbars=yes'
                      '\');; return false', 'return true')">
          <img tal:replace="structure
                             python:here.getImgTag(
                               item.absolute_url_path()+'/preview',
                               base_url='',width=th_width,height=th_height,
                               keep_ratio=1)">
          <br />
          <p tal:replace="item/Title"></p>
        </a>
      </td>
    </tal:block>
    </tr>
  </table>
</div>

<table width="100%" cellspacing="0" cellpadding="0" summary="batch layout"
  tal:condition="python:previous_page or next_page">
  <tr class="even">
    <td align="center" width="100%"
        tal:define="mq nocall:modules/ZTUtils/make_query;">
      <a href="." tal:condition="previous_page"
         tal:attributes="href python:'%s?%s'%(request['URL'],
                                              mq(request.form,
                                                 start=0))">«</a>
      <a tal:condition="previous_page"
         tal:attributes="href python:'%s?%s'%(request['URL'],
                                              mq(request.form,
                                                 start=previous_page.first))"
         i18n:translate="batch_previous">Previous</a>
      <a tal:condition="next_page"
         tal:attributes="href python:'%s?%s'%(request['URL'],
                                            mq(request.form, start=next_page.first))"
         i18n:translate="batch_next">Next</a>
      <a href="." tal:condition="next_page"
         tal:attributes="href python:'%s?%s'%(request['URL'],
                                              mq(request.form,
                                                 start=len(items) - (len(items) % nb_items)))">
        »</a>
    </td>
  </tr>
  <tr>
    <td>&nbsp;</td>
  </tr>
</table>


</tal:block>
